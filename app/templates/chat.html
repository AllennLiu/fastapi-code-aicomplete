<!DOCTYPE html>
<html>
    <head>
        <link rel="shortcut icon" href="https://fastapi.tiangolo.com/img/favicon.png">
        <title>💬 ChatBot</title>
    </head>
    <style>
        body {
            background-color: #22272e;
        }
        .head {
            color: aliceblue;
            font-family: 'Verdana, Geneva, Tahoma, sans-serif';
        }
        .message-box {
            font-size: 20px;
            font-family: 'Verdana, Geneva, Tahoma, sans-serif';
            font-weight: 500;
            color: lightskyblue;
            background-color: #2d333b;
            border-radius: 10px;
            border: none;
            margin: 20px 10px;
            padding: 10px;
            min-height: 80vh;
        }
        .input-box {
            font-size: 16px;
            font-weight: 500;
            font-family: 'Verdana, Geneva, Tahoma, sans-serif';
            color: lightslategray;
            padding: 10px;
            border-radius: 6px;
            border-width: thin;
            min-width: 200px;
            width: 300px;
            margin-left: 8px;
        }
        .sender {
            font-size: 15px;
            font-weight: 500;
            font-family: 'Verdana, Geneva, Tahoma, sans-serif';
            padding: 10px;
            background: skyblue;
            color: white;
            border: none;
            border-radius: 6px;
            margin-left: 8px;
            cursor: pointer;
        }
        .clear {
            background: indianred;
        }
        .sender:hover {
            opacity: .7;
            color: rgb(244, 244, 244);
        }
    </style>
    <body>
        <h1 class="head">Welcome ChatBot</h1>
        <form action="">
            <input class="input-box" type="text" id="messageText" autocomplete="off" required/>
            <button class="sender" id="sendButton" type="button" onclick="sendMessage(event)">提交信息</button>
            <button class="sender clear" id="clearButton" type="button">清除信息</button>
        </form>
        <div class="message-box"><ul id='messages'></ul></div>
        <script type="module">
            const helpMessages = async () => {
                const response = await fetch(`http://${location.host}/chat/help`)
                return await response.json()
            }
            const help = await helpMessages()
            document.getElementById('messages').innerHTML = `
            <li class="annoucement">
                <span style="color: green; font-weight: 600;">🤖：</span>
                <span>您好，可以问我任何问题，或尽可能描述与下列接近的句子来调用 API 工具！</span>
                <code><pre style="margin-block: 4px;">${JSON.stringify(help, null, 4)}</pre></code>
                <!--
                <span>您好，欢迎问我任何问题，我会尽可能回答！</span>
                -->
            </li>
            `
        </script>
        <script>
            const now = new Date()
            const input = document.getElementById('messageText')
            const messages = document.getElementById('messages')
            const sender = document.getElementById('sendButton')
            const tidyup = document.getElementById('clearButton')
            const date = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`
            tidyup.addEventListener('click', event => {
                if (messages.innerHTML.trim() === '') return
                if (confirm('请问是否要清除对话纪录？')) messages.innerHTML = ''
            })
            input.addEventListener('keydown', async event => event.keyCode === 13 && await sendMessage(event))
            const getHistory = () => {
                const history = []
                Array.from(messages.querySelectorAll('li')).forEach(e =>
                    e.className !== 'annoucement' && history.push({
                        role: e.className, content: e.innerText.split('：').slice(1).join('：')
                }))
                return history
            }
            const createStream = async () => {
                input.value = ''
                input.disabled = true
                sender.disabled = true
                const content = Array.from(messages.querySelectorAll('span')).pop()
                const response = await fetch(`http://${location.host}/chat/stream`, {
                    headers: { "Content-Type": "application/json" },
                    method : 'POST',
                    body   : JSON.stringify({ query: input.value, history: getHistory().slice(0, -2) })
                })
                const reader = response.body.getReader()
                content.innerHTML = ''
                while (true) {
                    const { done, value } = await reader.read()
                    const message = new TextDecoder().decode(value)
                    if (done) {
                        input.disabled = false
                        sender.disabled = false
                        return
                    }
                    content.innerHTML += `${message.replace(/(?:\r\n|\r|\n)/g, '<br>')}`
                    window.scrollTo(0, document.body.scrollHeight)
                }
            }
            const sendMessage = async event => {
                if (input.value.trim() === '') return
                const userMessage = document.createElement('li')
                const botMessage = document.createElement('li')
                const user = document.createElement('span')
                const assistant = document.createElement('span')
                const userText = document.createElement('span')
                userMessage.classList.add('user')
                botMessage.classList.add('assistant')
                userText.style.color = 'burlywood'
                userText.innerText = input.value
                user.innerHTML = '<span style="color: blue; font-weight: 600;">🦲：</span>'
                assistant.innerHTML = '<span style="color: green; font-weight: 600;">🤖：</span><span>…</span>'
                userMessage.appendChild(user)
                userMessage.appendChild(userText)
                botMessage.appendChild(assistant)
                messages.appendChild(userMessage)
                messages.appendChild(botMessage)
                await createStream()
                event.preventDefault()
            }
        </script>
    </body>
</html>
